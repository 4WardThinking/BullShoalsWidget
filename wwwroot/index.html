<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bull Shoals Lake Levels and Weather</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: .72;
      --muted2: rgba(255,255,255,.45);

      --up: #22c55e;
      --down: #fb7185;
      --flat: #94a3b8;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
    }

    /* FourWardCast theme (warm/cream background friendly) */
    body.fwc{
      /* Let the host background show through (your cream page) */
      background: transparent;
    }

    body.fwc .card{
      background: linear-gradient(
        180deg,
        rgba(255,255,255,.72),
        rgba(255,255,255,.58)
      );
      border: 1px solid rgba(80,86,53,.28); /* #505635 */
      /*box-shadow: 0 18px 60px rgba(80,86,53,.22);*/
    }

    body.fwc .card:before{
      background: radial-gradient(circle at 30% 30%, rgba(103,201,195,.28), transparent 60%); /* #67c9c3 */
    }

    body.fwc{
      --text: rgba(81,69,38,.96);      /* #514526 */
      --muted: rgba(80,86,53,.78);     /* #505635 */
      --muted2: rgba(80,86,53,.60);    /* #505635 */
      --border: rgba(80,86,53,.22);    /* #505635 */

      /* Trend colors matched to your swatch */
      --up: #67c9c3;    /* lake teal */
      --down: #ff522b;  /* sunset red */
      --flat: #efae2b;  /* warm gold */

      --shadow: 0 18px 60px rgba(80,86,53,.22);
      --shadow2: 0 8px 24px rgba(80,86,53,.16);
    }

    /* Pills + tiles in theme */
    body.fwc .badge,
    body.fwc .stat,
    body.fwc .weather{
      background: rgba(255,255,255,.52);
      border: 1px solid rgba(80,86,53,.22);
    }

    /* Keep the live dot green-ish but more ‚Äúbrand‚Äù */
    body.fwc .dot{
      background: #67c9c3;
      box-shadow: 0 0 0 3px rgba(103,201,195,.20);
    }

    /* Improve pill readability on light bg */
    body.fwc .trendPill{
      background: rgba(255,255,255,.50);
    }

    /* Give the big number a lighter shadow for light theme */
    body.fwc .big{
      text-shadow: 0 10px 22px rgba(80,86,53,.20);
    }

    /* Weather icon shadow should be lighter */
    body.fwc .wxIcon{
      filter: drop-shadow(0 4px 10px rgba(80,86,53,.20));
    }

    /* Transparent body */
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);

      min-height: 100vh;
      display: grid;
      place-items: start center;
      padding: 18px;

      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(34,197,94,.14), transparent 55%),
        linear-gradient(180deg, #070b14, #0b1220);
    }

    body.embed {
      background: transparent;
      padding: 0;
      min-height: auto;
      place-items: unset;
      margin: 0;
      overflow: hidden;
    }

    body.embed,
    body.embed * {
      scrollbar-width: none;
    }

    body.embed.scale {
      padding: 0;
      height: 100%;
      display: grid;
      place-items: center;
    }

    body.embed.scale .wrap {
      max-width: none;     /* remove 420px cap */
      width: 100%;
      height: 100%;
      padding: 0;
      display: grid;
      place-items: center;
    }

    body.embed.scale .card {
      width: min(100%, 860px);  /* grows on big screens but won‚Äôt get absurd */
      max-height: 100%;
      height: auto;
      overflow: hidden;
      border-radius: 18px;
    }

    body.embed .wrap { padding: 0; }

    .wrap{
      width: 100%;
      max-width: 420px;
      padding: 12px;
      box-sizing: border-box;
    }

    /* Allow the widget to fill the parent iframe when requested */
    html, body { height: 100%; }

    body.embed.fill {
      height: 100%;
      min-height: 100%;
      padding: 0;
      display: block;
    }

    body.embed.fill .wrap {
      max-width: none;     /* <-- removes 420px cap */
      height: 100%;
      padding: 0;
      display: block;
    }

    body.embed.fill .card {
      height: 100%;
      width: 100%;
      border-radius: 18px; /* keep your rounded look */
    }

    /* Optional: make internal layout adapt better when tall */
    body.embed.fill .content {
      height: calc(100% - 58px); /* top header area */
      display: flex;
      flex-direction: column;
    }

    .card{
      position: relative;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-120px -120px auto auto;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.22), transparent 60%);
      pointer-events:none;
      filter: blur(0px);
    }

    .top{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px 10px;
      align-items:flex-start;
    }

    .title{
      font-weight: 850;
      letter-spacing: .2px;
      font-size: 16px;
      line-height: 1.15;
    }

    .asof{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      user-select:none;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: var(--up);
      box-shadow: 0 0 0 3px rgba(34,197,94,.18);
    }

    .content{
      padding: 0 14px 14px;
    }

    .hero{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items:flex-end;
      padding: 10px 0 14px;
    }

    .hero .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }

    .big{
      font-size: 40px;
      font-weight: 900;
      letter-spacing: -0.8px;
      line-height: 1;
      text-shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    .unit{
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
      margin-left: 6px;
    }

    .trendPill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.20);
      user-select:none;
      min-width: 92px;
      justify-content:center;
    }

    .trendPill.up{ color: var(--up); }
    .trendPill.down{ color: var(--down); }
    .trendPill.flat{ color: var(--flat); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .stat{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px 10px 9px;
    }

    .stat .k{
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }

    .stat .v{
      margin-top: 6px;
      font-weight: 900;
      font-size: 18px;
      letter-spacing: -0.2px;
    }

    .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted2);
      font-weight: 650;
      display:flex;
      justify-content: space-between;
      gap: 10px;
    }

    .weather{
      margin-top: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px 10px 9px;
      display:flex;
      justify-content: center;
      align-items:center;
      text-align: center;
      gap: 12px;
    }

    .wxLeft{
      min-width: 0;
    }

    .wxTop{
      display:flex;
      align-items:center;
      justify-content: center;
      gap: 10px;
    }

    .wxIcon{
      font-size: 22px;
      line-height: 1;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
    }

    .wxTemp{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -0.2px;
    }

    .wxSummary{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
      max-width: 270px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .footer{
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted2);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .footer a{ color: inherit; text-decoration:none; }
    .footer a:hover{ text-decoration: underline; }

    /* error/loading */
    .state{
      padding: 12px 14px 14px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 650;
    }

    @media (prefers-color-scheme: light){
      :root{
        --card: rgba(0,0,0,.03);
        --border: rgba(0,0,0,.10);
        --text: rgba(15,23,42,.96);
        --muted: rgba(15,23,42,.64);
        --muted2: rgba(15,23,42,.45);
        --shadow: 0 18px 60px rgba(2,6,23,.12);
        --shadow2: 0 8px 24px rgba(2,6,23,.10);
      }
      .card{
        background: linear-gradient(180deg, rgba(255,255,255,1), rgba(248,250,252,1));
      }
      .badge, .stat, .weather{ background: rgba(255,255,255,.70); }
      .dot{ box-shadow: 0 0 0 3px rgba(34,197,94,.16); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="group" aria-label="Bull Shoals lake and tailwater levels">
      <div class="top">
        <div>
          <div class="title">Bull Shoals</div>
          <div class="asof" id="asof">Loading‚Ä¶</div>
        </div>
        <div class="badge" id="badge">
          <span class="dot" aria-hidden="true"></span>
          <span id="badgeText">Live</span>
        </div>
      </div>

      <div class="content" id="content" hidden>
        <div class="hero">
          <div>
            <div class="label">Lake level</div>
            <div>
              <span class="big" id="lakeValue">--</span>
              <span class="unit">ft</span>
            </div>
          </div>
          <div class="trendPill flat" id="lakeTrend">‚Ä¢ 0.00 ft</div>
        </div>

        <div class="grid">
          <div class="stat">
            <div class="k">Tailwater</div>
            <div class="v"><span id="tailValue">--</span> <span class="unit">ft</span></div>
            <div class="sub">
              <span>Trend</span>
              <span id="tailTrendText">‚Ä¢ 0.00 ft</span>
            </div>
          </div>

          <div class="stat">
            <div class="k">Last update</div>
            <div class="v" id="lastUpdate">--</div>
            <div class="sub">
              <span>Prev</span>
              <span id="prevUpdate">--</span>
            </div>
          </div>
        </div>

        <div class="weather">
          <div class="wxLeft">
            <div class="wxTop">
              <div class="wxIcon" id="wxIcon" aria-hidden="true">‚õÖ</div>
              <div class="wxTemp"><span id="temp">--</span>¬∞F</div>
            </div>
            <div class="wxSummary" id="wxSummary">--</div>
            <div class="wxSummary" id="wxDetails" style="opacity:.85">--</div>
          </div>
        </div>

        <div class="footer">
          <span>Source: <a href="https://cwms-data.usace.army.mil/cwms-data/swagger-ui.html" target="_blank" rel="noopener">USACE CWMS</a></span>
          <span>Weather: NWS</span>
          <span>Built by: <a href="https://github.com/4WardThinking" target="_blank" rel="noopener">4WardThinking</a></span>
        </div>
      </div>

      <div class="state" id="state">Loading data‚Ä¶</div>
    </div>
  </div>

  <script>
    function trend(delta) {
      const eps = 0.001;
      if (delta > eps) return { cls: "up", sym: "‚ñ≤", word: "up" };
      if (delta < -eps) return { cls: "down", sym: "‚ñº", word: "down" };
      return { cls: "flat", sym: "‚Ä¢", word: "flat" };
    }

    function fmtDelta(delta) {
      const sign = delta > 0 ? "+" : "";
      return `${sign}${delta.toFixed(2)} ft`;
    }

    function weatherIcon(summary) {
      const s = (summary || "").toLowerCase();
      if (s.includes("thunder")) return "‚õàÔ∏è";
      if (s.includes("snow") || s.includes("sleet")) return "üå®Ô∏è";
      if (s.includes("rain") || s.includes("showers")) return "üåßÔ∏è";
      if (s.includes("fog") || s.includes("haze")) return "üå´Ô∏è";
      if (s.includes("clear") || s.includes("sunny")) return "‚òÄÔ∏è";
      if (s.includes("cloud")) return "‚òÅÔ∏è";
      return "‚õÖ";
    }

    async function load() {
      const state = document.getElementById("state");
      const content = document.getElementById("content");
      const badgeText = document.getElementById("badgeText");

      try {
        const r = await fetch("/api/status", { cache: "no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();

        // As-of time
        document.getElementById("asof").textContent = `As of ${d.lakeLevelFt.current.timeCentral}`;

        // Lake
        document.getElementById("lakeValue").textContent = d.lakeLevelFt.current.value.toFixed(2);
        const lt = trend(d.lakeLevelFt.delta);
        const lakeTrend = document.getElementById("lakeTrend");
        lakeTrend.className = `trendPill ${lt.cls}`;
        lakeTrend.textContent = `${lt.sym} ${fmtDelta(d.lakeLevelFt.delta)}`;
        lakeTrend.setAttribute("aria-label", `Lake level trend ${lt.word}, change ${fmtDelta(d.lakeLevelFt.delta)}`);

        // Tailwater
        document.getElementById("tailValue").textContent = d.tailwaterFt.current.value.toFixed(2);
        const tt = trend(d.tailwaterFt.delta);
        document.getElementById("tailTrendText").textContent = `${tt.sym} ${fmtDelta(d.tailwaterFt.delta)}`;

        // ‚ÄúLast update‚Äù stat
        document.getElementById("lastUpdate").textContent = d.tailwaterFt.current.timeCentral.split(" ")[1];
        document.getElementById("prevUpdate").textContent = d.tailwaterFt.previous.timeCentral.split(" ")[1];

        // Weather
        document.getElementById("temp").textContent = Math.round(d.weather.temperatureF);
        document.getElementById("wxSummary").textContent = d.weather.summary;
        document.getElementById("wxIcon").textContent = weatherIcon(d.weather.summary);
        const parts = [];

        if (d.weather.relativeHumidityPct != null)
          parts.push(`Humidity ${Math.round(d.weather.relativeHumidityPct)}%`);

        if (d.weather.windDirection && d.weather.windSpeedMph != null)
          parts.push(`Wind ${d.weather.windDirection} ${Math.round(d.weather.windSpeedMph)} mph`);
        else if (d.weather.windSpeedMph != null)
          parts.push(`Wind ${Math.round(d.weather.windSpeedMph)} mph`);

        if (d.weather.probabilityOfPrecipPct != null)
          parts.push(`Rain ${Math.round(d.weather.probabilityOfPrecipPct)}%`);

        document.getElementById("wxDetails").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "";

        state.hidden = true;
        content.hidden = false;
        badgeText.textContent = "Live";
      } catch (e) {
        badgeText.textContent = "Error";
        state.textContent = "Failed to load data.";
      }
    }

    if (params.get("embed") === "1") document.body.classList.add("embed");

    const mode = params.get("mode");
    if (mode === "scale") document.body.classList.add("scale");

    const theme = params.get("theme");
    if (theme === "fwc" || theme === "fourwardcast") {
      document.body.classList.add("fwc");
    }

    load();
  </script>
</body>
</html>
